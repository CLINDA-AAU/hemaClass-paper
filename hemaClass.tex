\documentclass{article}

%%% PREAMBLE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{preamble.tex}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{\hemaClassTitle{}}

\author[1]{Steffen Falgreen\thanks{Shared first authorship}}
\author[12]{Anders Ellern Bilgrau$^\ast$}
\author[12]{Lasse Hjort Jakobsen}
\author[12]{Jonas Have}
\author[12]{Kasper Lindblad Nielsen}
\author[1]{Tarec Christoffer El-Galaly}
\author[1]{Julie St{\o}ve  B{\o}dker}
\author[1]{Alexander Schmitz}
\author[3]{Ken H. Young}
\author[12]{Hans Erik Johnsen}
\author[12]{Karen Dybk{\ae}r}
\author[12]{Martin B{\o}gsted\thanks{To whom correspondence should be addressed (\texttt{mboegsted@dcm.aau.dk})}}

\affil[1]{Department of Haematology, Aalborg University Hospital}
\affil[2]{Department of Clinical Medicine, Aalborg University}
\affil[3]{Department of Hematopathology, The University of Texas, MD Anderson Cancer Center}

% Steffen Falgreen - sfl@rn.dk
% Anders Ellern Bilgrau - anders.ellern.bilgrau@gmail.com
% Lasse Hjort Jakobsen - lasse.j@rn.dk
% Jonas Have - jonas.have@rn.dk
% Kasper Lindblad Nielsen - k.lindblad@rn.dk
% Tarec Christoffer El-Galaly - tarec.galaly@gmail.com
% Julie S.\  B\o dker - j.boedker@rn.dk
% Alexander Schmitz - alex.schmitz@rn.dk
% Hans E.\ Johnsen - haej@rn.dk
% Karen Dybk\ae r - k.dybkaer@rn.dk
% Martin B\o gsted - martin.boegsted@rn.dk

\begin{document}

\maketitle
\phantomsection
\addcontentsline{toc}{section}{Abstract}
\begin{abstract}
\parttitle{Background} %if any
Dozens of genomics based cancer classification systems have been introduced with prognostic, diagnostic, and predictive capabilities.
However, they often employ complex algorithms and are only applicable on whole cohorts of patients, making them difficult to apply in a personalized clinical setting.
This prompted us to create \hemaClass{}, an online web application providing an easy interface to one-by-one microarray based risk classifications of diffuse large B-cell lymphoma (DLBCL) and multiple myeloma (MM) into e.g.\ oncogenomic cell-of-origin and chemotherapeutic resistance classes.
Laboratory specific effects cannot be accounted for in true one-by-one microarray normalisation, however.
Hence, \hemaClass{} optionally allows the user to supply a reference dataset to increase the accuracy of the classifications.
\\\parttitle{Results}
Classification results for one-by-one array pre-processing with and without a user supplied reference dataset were compared to cohort based classifiers in $4$ publicly available datasets.
Overall, \hemaClass{} yields satisfactory inter-method agreements across all datasets.
The website is essentially the \R{}-package \pkg{hemaClass} accompanied by a Shiny web application.
The well-documented package can be used to run the website locally or to use the developed methods programatically.
\\\parttitle{Conclusions}
The website and \R{}-package is relevant for biological and clinical lymphoma researchers as it provides reliable and swift methods for calculation of disease subclasses.
The proposed one-by-one pre-processing methods are relevant for all researchers using microarrays.
\medskip\\
\textbf{Keywords:~}
Diffuse Large B-Cell Lymphoma; Multiple Myeloma; Oncogenomics; Classification; Chemoresistance; Microarray; Pre-processing; Robust Multichip Average; Gene expression profiling; Cell of origin
\end{abstract}



\section{Background}
In addition to current clinically used risk factor scoring systems several independent gene expression profile (GEP) based risk stratifications have been proposed with biological and clinical significance in hematological cancers.
Although drug targetable genes which are only expressed in subtypes of the e.g.\ DLBCL tumours have been identified, they are not readily applicable in clinical research and routine settings due to lack of available routine diagnostic tests \citep{Jaffe2009, Sehn2014}.

\citet{Alizadeh2000} developed an important example of a biological sub-classification of lymphoma.
On the basis of GEP analyses, DLBCL cases were assigned to categories of activated B-cell phenotype (ABC) or germinal center B-cell phenotype (GCB) with different clinical outcomes.
The validity of this classification and its prognostic importance has been confirmed in a number of later studies \citep{Rosenwald2002a,Hans2004,Poulsen2005,Lenz2008a,Monti2012a}.
Recently, we have refined the ABC/GCB subclassification of DLBCL to include a B-cell Associated Gene Signature (BAGS) classifier \citep{DybkaerBoegsted2015} capable of classifying DLBCL samples into $5$ different B-cell subtypes:
Naive (N), Centrocyte (CC), Centroblast (CB), Memory (M), and Plasmablasts (PB).
For example, the BAGS classifier stratifies the GCB subclass into a CC subtype with superior survival as compared to the CB subtype \citep{DybkaerBoegsted2015} which opens up for considering different treatment regimes in the GCB class of patients.
In another study \citep{Falgreen2015} we developed classification based resistance gene signatures (REGS) for the most prominent drugs used in the treatment of DLBCL patients:
Cyclophosphamide (C), Doxorubicin (H), and Vincristine (O).
However, these and most existing algorithms are only applicable in the presence of whole cohorts of patients making them difficult to apply in a routine clinical setting.

The traditional lymphoma staging and risk classification systems are based on the Ann Arbor classification for staging of lymphoma (extent of disease and extranodal involvement) and simple prognostic tools such as the international prognostic index (IPI, \citep{IPI}) for large cell lymphoma and the Follicular Lymphoma International Prognostic Index (FLIPI, \citep{FLIPI}), both derived from patient age, performance status, easy available blood tests, and disease stage.
Due to the simplicity of these clinical risk stratification algorithms they are still the most widely used risk scoring systems today.
Risk stratification according to these algorithms have been systematised and made easily accessible for desktop, online, and even smart-phone use.
However, easily accessible molecular classification methods are lacking behind and thereby delaying the translation of new molecular findings into clinical practice.
A few methods exist for cancer types other than lymphoma, including acute myeloid leukemia (AML) \citep{Huang2009}.
But to the best of our knowledge, quite surprisingly, no tools have been developed for use in the lymphoma field despite very early promising results in the molecular biomarker field.
An accessible Windows based application has been published for ABC/GCB classification \citep{Care2013}.
Although \citet{Care2013} develops a new ABC/GCB classifier which is stable across microarray technologies and trial centres, the ABC/GCB classifier is potentially biased towards classes which differentiate the prognosis and not biology.
This bias arises as the ensemble of classifiers are chosen on basis of their ability to separate survival.
Nevertheless, the need for a whole cohort of patients is still present in this application.

In clinical settings, the methods need to be applicable for a single patient sample and straightforward to use.
This prompted us to develop an easy accessible and flexible web-based tool for ABC/GCB, BAGS, and REGS classification which is capable of computing our recently developed classifiers.
The classifications made by the web-based tool \hemaClass{} are compared to the existing state-of-the-art and approved ABC/GCB classifications of DLBCL.
We believe that \hemaClass{} will provide a novel and user-friendly concept for bringing complex molecular classification of disease more swiftly into daily clinical practice.
As already delineated, this paper primarily describes developed classification schemes for DLBCL although MM classification is currently also featured on the website.
A more extensive treatment of MM classification schemes is in preparation and will be implemented on \hemaClass{}.


\section{Implementation}

\subsection{Classification workflow}
The analysis workflow of \hemaClass{} can be divided into four parts:
(1) Three reference datasets which have been pre-processed and prepared offline are loaded upon server start,
(2) a graphical user interface with upload and input facilities,
(3) a server handling the online processing and classification of the user input, and
(4) the resulting classifications available for download and inspection via the user interface.
The workflow architecture is illustrated in Figure \ref{fig:webtooldiagram}.

\begin{figure}
\begin{center}
\includegraphics[width=0.5\textwidth]{figures/Flowchart6.pdf}
\end{center}
\caption{Diagram of the workflow architecture.}
\label{fig:webtooldiagram}
\end{figure}


\subsection{Software availability and technical details}
The interactive web application available at \url{hemaclass.org} was created using the statistical programming language \R{} \citep{RCoreTeam}, the software package \pkg{shiny} \citep{shiny}, and the accompanying Linux server software.
All \hemaClass{} functionality, including the RMA normalisation and classification procedures, are available through the accompanying package \pkg{hemaClass} based on a number of packages from the Comprehensive R Archive Network \citep{RCoreTeam} and the Bioconductor environment \citep{Gentleman2004}.
The Shiny server handles the interaction between the front end web application and the back end \R{} processing.
The back end is essentially the well-documented \pkg{hemaClass} package which can be utilized as a programmatical interface to the functionality of the website.
However, the package also allows users to run a local instance of the website if one wishes to avoid uploading large files to our servers.
The development and latest version of \pkg{hemaClass} is open source and freely available at \url{https://github.com/oncoclass/hemaclass} for sharing, modification, and redistribution.
All bug-reports, suggestions, and comments on the website or package are welcome following the latter link.
The regular RMA pre-processing is carried out with the Bioconductor package \pkg{affy} \citep{Gautier2004}.
Core functions for the one-by-one and reference based RMA pre-processing are written in \textsf{C++} and imported to \R{} using \pkg{Rcpp} and \pkg{RcppArmadillo} \citep{Rcpp2013,Eddelbuettel2011,RcppArmadillo,Sanderson2010}.





\subsection{Data overview}
The seven gene expression datasets used in this paper are summarised in Table \ref{table:01}.
All GEP data are on the Affymetrix GeneChip HG-U133 Plus 2.0 array and available at the Gene Expression Omnibus (GEO) \citep{Barrett2013} website (\url{http://www.ncbi.nlm.nih.gov/geo/}).
To establish the classifiers the following datasets are used:
\begin{enumerate}
  \item Gene expression data from $181$ CHOP treated DLBCL patients are used to establish the ABC/GCB classifier.
  This cohort will be referred to as the \emph{LLMPP CHOP} (Lymphoma/Leukemia Molecular Profiling Project CHOP) cohort \citep{Lenz2008a}.
  The cohort is also used as a reference set for normalisation of arrays.
  \item The BAGS classifier is based on gene expression data from eight human tonsils sorted in five B-cell subsets.
  This dataset will be referred to as the \emph{tonsil dataset} and it is also used for scaling of gene expression data for BAGS classification \citep{DybkaerBoegsted2015}.
  \item The REGS classifiers are based on a panel of $12$ Multiple Myeloma (MM) and $14$ DLBCL cell lines.
  This panel will be referred to as \emph{BCELL26}.
  The DLBCL part of the cell line panel is used for scaling of patient data and this part of the dataset will be referred to as   \emph{DLBCL14} \citep{Falgreen2015}.
\end{enumerate}
For validation the following four DLBCL cohorts are used:
\begin{enumerate}
  \item[4.] The Aalborg OCT cohort (\emph{CHEPRETRO}) of $89$ Danish DLBCL patients undergoing first-line treatment at Aalborg University Hospital \citep{DybkaerBoegsted2015}.
  The clinical dataset is as registered in the National Clinical Quality Database for Malignant Lymphoma (LYFO, \url{lymphoma.dk}) \citep{Gang2012}.
  \item[5.] The International DLBCL Rituximab-CHOP Consortium MD Anderson (\emph{IDRC}) cohort of $470$ DLBCL patients treated with R-CHOP first-line therapy \citep{Visco2012}.
  Note, that these samples are formalin-fixed, paraffin-embedded (FFPE).
  \item[6.] The Lymphoma/Leukemia Molecular Profiling Project R-CHOP (\emph{LLMPP R-CHOP}) cohort of $233$ DLBCL patients treated with R-CHOP first-line therapy \citep{Lenz2008a}.
  \item[7.] The Mayo-Dana-Farber Cancer Institute (\emph{MDFCI}) cohort of $90$ DLBCL patients treated with R-CHOP first-line therapy \citep{Monti2012a}.
\end{enumerate}
The GEO datasets were downloaded using the \R{}-package \pkg{DLBCLdata} \citep{DLBCLdata}.

\input{tables/table1.tex}



\subsection{One-by-one RMA normalization}
Recall that robust multichip average (RMA) pre-processing consists of three steps in order:
(1) Background correction,
(2) quantile normalisation, and
(3) summarisation of probes to probe-sets \citep{Irizarry2003}.
Confer \citet{Bolstad2004} for a comprehensive account on RMA.
Both the quantile normalisation and summarisation procedures of RMA are cohort based and hence need to be altered to facilitate a one-by-one RMA pre-processing scheme.
As quantile normaliser, the empirical cumulative distribution function (ECDF) of the mean of the sample quantiles of the RMA background corrected LLMPP CHOP reference data is used in place of the usually applied ECDF of the mean of the sample quantiles of the user supplied data \citep{Bolstad2003}.
To mimic the summarisation procedure of RMA \citep{Irizarry2003b} the probe effects estimated by median polish for the LLMPP CHOP reference data is subtracted all probes of the user data.
The RMA pre-processed expression value for each probe-set is then estimated as the median of the associated probes.
Finally, before classification the median of each probe-set in the LLMPP CHOP is subtracted from the corresponding probe-set in the user data.
This ensures identical classification probabilities whether data is supplied as a cohort or one-by-one.

To accommodate laboratory and sample preparation specific effects different from the LLMPP CHOP reference data, \hemaClass{} allows the user to upload an alternative dataset which is to be used in place of LLMPP CHOP as reference.
In this paper the reference datasets consisted of $30$ randomly selected samples from a given study.
The three pre-processing methods will be referred to as \emph{cohort}, \emph{one-by-one}, and \emph{reference based} normalisation.


\subsection{Classification methods}

\subsubsection{Elastic nets}
Logistic and multinomial regression are used in all classification methods available on \hemaClass{}.
However, in GEP experiments, the number of probe-sets present on the microarray always outnumbers the sample size.
Collinearity present among the features further aggravates the problem of identifying genes responsible for the underlying biological mechanism.
Regression under these ill-posed circumstances is typically handled by so-called regularisation.
Here the elastic net penalty \citep{Friedman2010, Zou2005} is used which is a combination of the lasso \citep{Tibshirani1996} and ridge regression \citep{Hoerl1970}.
Similar to the lasso, this penalty ensures simultaneous variable selection and model estimation by forcing small coefficients to be zero, yielding sparse solutions.
In contrast to the lasso, the elastic net penalty is capable of selecting more variables than samples.

The elastic net penalty contains two parameters $\alpha$ and $\lambda$.
The parameter $\alpha$ interpolates the elastic net penalty between the ridge and the lasso penalty which corresponds to values of $0$ and $1$, respectively.
The parameter $\lambda$ determines the amount of shrinkage of the coefficients with larger values inducing more shrinkage until no variables are contained in the model.
Regularised logistic and multinomial regression are performed with the \R{}-package \pkg{glmnet} \citep{Friedman2010}.

\subsubsection{ABC/GCB classification}
The ABC/GCB classifier is established using logistic regression with an elastic net penalty on the LLMPP CHOP cohort.
Of the $181$ patients $74$ were ABC, $76$ were GCB, and $31$ were non-classified.
Using the $150$ patients classified as either ABC or GCB the dichotomous classifier capable of assigning each sample an estimate of the probability of being ABC was established.

To avoid over-fitting and limit the number of noise contributing genes, the elastic net parameters $\alpha$ and $\lambda$ were chosen through $10$ fold cross-validation.
The parameter $\alpha$ was varied between $0.1$ and $1$ with step size $0.025$ and $\log(\lambda)$ was varied between $-10$ and $2$ with step size $0.06$.
The optimal combination of the parameters and thereby the number of probe-sets were found at the values minimising the deviance.
The results of the cross validation are shown in Supplementary Figure \ref{fig:crossval}.
The minimum $0.13$ was attained at $\alpha = 0.15$ and $\log(\lambda) = -7.41$ resulting in a gene expression classifier consisting of $381$ probe-sets.

When a tumour sample is classified according to the ABC/GCB classifier using reference based normalisation the associated gene expressions are rescaled probe-set wise by the standard deviation of the LLMPP CHOP data divided by the standard deviation of the user supplied reference data.
In contrast, the one-by-one normalised data is used directly.

\subsubsection{REGS classification}
\label{sec:regsmethods}
In the paper by \citet{Falgreen2015} REGS classifiers were established for prediction of resistance to the drugs C, H, and O.
The classifiers were established on BCELL26 using regularised logistic regression analogous to the procedure described for the aforementioned ABC/GCB classifier.

The probability of resistance to the combination therapy $p_{CHO}$ is estimated based on the probabilities of drug resistance toward the each of three drugs $p_C$, $p_H$, and $p_O$, respectively.
This probability is calculated by a formula derived as the posterior probability of being resistant given resistance towards each of the individual drugs under the assumption of conditional independence and uniform priors.
The formula is also known as Graham's formula:
\begin{equation*}
  p_{CHO} = \frac{p_C p_H p_O}{p_C p_H p_O + (1 - p_C)(1 - p_H)(1 - p_O)},
\end{equation*}
derived in supplementary section \ref{sec:graham}.
If a drug is left out in the combination therapy the drug is simply removed from the formula.

When a tumour sample is classified according to the REGS classifiers the associated gene expressions are rescaled probe-set wise by the standard deviation of DLBCL14 divided by the standard deviation of the LLMPP CHOP dataset.
Similarly to the other classifiers the LLMPP CHOP cohort is replaced by the user reference dataset, if supplied.

Resistance classifiers for other chemotherapeutic drugs and diseases are also available on \hemaClass{} though established elsewhere \citep{Boegsted2011,Bogsted2013,Laursen2014}.
The Rituximab resistance classifier of \citet{Laursen2014} is based upon an elastic net approach, like above, however using three classes.
The Melphalan resistance classifier of \citet{Boegsted2011} uses sparse partial least squares to assign the classes sensitive, intermediate, and resistant to samples.
This classifier was developed for multiple myeloma (MM) patients and thus based on other data \citep{Boegsted2011}.
A classifier for dexamethasone is still considered experimental and currently available only in the package.


\subsubsection{BAGS classification}
The BAGS classifier established by \citet{DybkaerBoegsted2015} was based on multinomial regression regularised by an elastic net penalty.
The classifier was trained on the Tonsil dataset in a manner similar to the ABC/GCB classifier.

When a tumour sample is classified according to the BAGS classifier the associated gene expressions are rescaled probe-set wise by the standard deviation of the tonsil data divided by the standard deviation of the LLMPP CHOP dataset.
If the user supplies a reference dataset this is used in place of LLMPP CHOP.
The rescaling is performed to make the data comparable to the tonsil dataset.


\subsection{Inter-method reproducibility assessments}
To evaluate the reproducibility of the class probabilities obtained through cohort based normalisation and \hemaClass{} normalisation, Pearson's correlation coefficient for the logit-transformed probabilities and $95\%$ confidence interval (CI) were calculated for each classifier and dataset.
The identity and \emph{total} least square regression lines were compared to assess bias in the estimated probabilities \citep{CHEN1989}.
Total least squares regression was used as errors are present in both classification probabilities.

For each classifier the associated categories were obtained by thresholding the estimated probabilities.
The ABC/GCB classifier was thresholded by $0.1$ and $0.9$, i.e.\ a tumour sample was classified as ABC when the estimated probability exceeds $0.9$, GCB when it is beneath $0.1$, and unclassified otherwise.
For the BAGS classifier a tumour was classified as N, CB, CC, M, or PB if the associated probability exceeded $0.5$ and unclassified when this threshold was not met for any subtype.
For the REGS classifiers, C, H, O, and CHO combined, the threshold used were the $33\%$ and $66\%$ percentile of the estimated probabilities, found to be $[0.46, 0.67]$, $[0.1, 0.86]$, $[0.38, 0.54]$, and $[0.07, 0.91]$, respectively.
The classifiers were applied to the datasets using the cohort, one-by-one, and reference based RMA normalisation.
After thresholding the class probabilities confusion matrices were created.
From these the rate of agreement (or accuracy), Cohen's weighted $\kappa$, and corresponding $95\%$ CIs were computed to assess the agreement between the determined classes.


\section{Results}
\subsection{Using \hemaClass{}}
The website is an easy-to-use, interactive interface for \pkg{hemaClass} with the desired RMA normalization and the classification methods selected by the user.
The usage of the website is largely self-explanatory with context-dependent boxes aiding users with further information, warnings, or errors.
A comprehensive tutorial and guide to both the website and package is provided on the website or by running \texttt{vignette("howto")} in \R{}.
Users upload patient samples which are normalized and classified depending on settings chosen by the users.
A text summary of the results and a plot of the predicted overall survival and progression free survival is optionally provided for each patient sample.
These predictions are based on patient survival data from LLMPP, MDFCI, and IDRC using a Cox regression with IPI and a combination of the ABC/GCB and BAGS classes.



\subsection{ABC/GCB classification}
In order to classify patients as ABC/GCB based on the implemented one-by-one normalisation method a classifier based on the regularised logistic regression was established.
The classifications were evaluated in the four clinical cohorts CHEPRETRO, MDFCI, IDRC, and LLMPP R-CHOP, which have all been classified according to the Wright's naive Bayes classifier \citep{Wright2003,Lenz2008a}.
The rate of agreement between the two classifiers are shown in Table \ref{tab:ABCGCBclassifier}.
Note that unclassified samples were included in the estimation of this rate i.e.\ a patient classified as ABC by one classifier but unclassified by the other is considered an error.
The table also includes the alternative measure of agreement, Cohen's weighted $\kappa$, were misclassifications involving the unclassified group are weighted by $1/2$.
The accompanying confusion matrices are shown in the first rows of Supplementary Table \ref{tab:confusionABCGCBHEMA}.

The logit probability of being ABC estimated using the established cohort-based classifier was compared to the corresponding estimate obtained through the one-by-one based classification scheme in Figure \ref{fig:ABCGCBDrug}A for CHEPRETRO.
The probabilities estimated through the two methods are very similar.
However, the probabilities estimated under one-by-one normalisation are slightly uncalibrated (or biased) and skewed upwards, indicating that different cut points might be used for the classifications.
By normalising to a reference set of $30$ randomly selected samples from CHEPRETRO this error and bias is greatly minimised as shown in Figure \ref{fig:ABCGCBDrug}B.

For both methods, patients are classified as ABC when the estimated probability exceeds $0.9$ and GCB when it is below $0.1$.
In Table \ref{tab:classALL} the resulting classifications are compared in terms of accuracy and Cohen's weighted $\kappa$ for the four validation datasets.
CHEPRETRO, MDFCI, IDRC, and LLMPP R-CHOP all show a high Cohen's weighted $\kappa$ and good rate of agreement, considering that misclassifications involving unclassified samples count as errors.
The reduced rate of agreement and Cohen's weighted $\kappa$ using one-by-one pre-processing in IDRC may be due to the samples being FFPE although this seems to be remedied by reference based pre-processing.
The accompanying confusion matrices are shown in the lower part of Supplementary Table \ref{tab:confusionABCGCBHEMA}.
Note, changes in predicted classes are mainly due to shifts into NC from ABC or GCB.
Direct disagreements between the classifiers are seemingly rare and only occurs in the IDRC dataset.

\input{tables/table2.tex}

\begin{figure}
\begin{center}
\includegraphics[width=0.375\textwidth]{figures/figure2.pdf}
\end{center}
\caption{Comparison of logit probabilities for ABC/GCB and REGS classification obtained through cohort normalisation and \hemaClass{}.
The areas marked with green indicate patients with similar classification between \hemaClass{} and cohort based normalisation.
Contrary, the areas marked with red indicate complete misclassifications.
For ABC/GCB and REGS the white areas indicate unclassified and intermediate resistance, respectively, in at least one of the classifiers.
The dashed and solid line shows the identity and total least squares line, respectively.}
\label{fig:ABCGCBDrug}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=0.375\textwidth]{figures/figure3.pdf}
\end{center}
\caption{Comparison of logit probabilities for the BAGS classifier obtained through one-by-one and reference based RMA normalization of \hemaClass{} against cohort RMA normalisation.
The coloured regions in the figure correspond to a threshold probability of $0.5$.
The dashed and solid line shows the identity and total least squares line, respectively.}
\label{fig:Bagscorr}
\end{figure}
\newpage



\subsection{REGS classification}
The probability of resistance towards each of the three drugs C, H, and O was estimated using \hemaClass{} both in terms of one-by-one and reference based normalisation.
The logit probabilities of resistance are plotted against those obtained by cohort based normalisation in Figure \ref{fig:ABCGCBDrug}.
Panels C, E, G, and I show the plots based on one-by-one normalisation and panels D, F, H, and J show the plots for the reference based normalisation.
The probabilities obtained by one-by-one and cohort based normalisation are comparable. However, similar to the other classifiers the one-by-one normalisation leads to slightly skewed and biased probabilities, indicating that different cut points should be considered.
The probabilities obtained by the reference based normalisation resembles the cohort based to a great extent indicating that similar well-calibrated probabilities are obtainable for different laboratories by supplying a reference set.

Based on the estimated probabilities, the patients were categorised as sensitive, intermediate, or resistant based on the thresholds specified in Section \ref{sec:regsmethods}.
The classes obtained by \hemaClass{} are compared to those obtained by the cohort based approach in Table \ref{tab:classALL} in terms of rate of agreement and Cohen's weighted $\kappa$.
The associated confusion matrices for one-by-one normalisation and reference based normalisation are shown in Supplementary Table \ref{tab:confusiondrugonebyone} and Supplementary Table \ref{tab:confusiondrugreference}, respectively.
Again, the reference based approach yields superior agreement with classifications using cohort based normalisation.


\subsection{BAGS classification}
The BAGS classifier was evaluated in a manner similar to the ABC/GCB classifier.
The logit probability of a patient's tumour originating from one of the five subpopulations is again estimated by means of cohort, one-by-one, and reference based normalisation.
The logit probabilities estimated by the one-by-one normalisation is plotted against that of the cohort based normalisation in Figure \ref{fig:Bagscorr} panels A, C, E, G, and I for CHEPRETRO.
The correlations between the logit probabilities are highly significant, although slightly skewed and biased.
To accommodate this, the data was also normalised using a reference dataset.
The logit probabilities estimated by the reference based normalisation is plotted against that estimated for the cohort based normalisation in Figure \ref{fig:Bagscorr} panels B, D, F, H, and J for CHEPRETRO.
The reference based normalisation removes much of the aforementioned bias.

Based on the probabilities estimated by means of each of the three normalisation methods the patients of the four clinical cohorts are grouped into the BAGS.
The rate of agreement between the cohort based and \hemaClass{} classifications is shown in Table \ref{tab:classALL} along with the Cohen's weighted $\kappa$.
The associated confusion matrices are shown in Supplementary Table \ref{tab:BAGShemaclass}.

\input{tables/table3.tex}


\section{Discussion}
Despite the enormous resources spent on developing molecular based cancer classification systems,
most of these are still not available in daily clinical practice.
% there seems to be an inertial resistance to develop clinical applications.
To allow for fast validation of our recent findings \citep{DybkaerBoegsted2015, Falgreen2015}, we have developed an easily accessible web application that permits other users to apply ABC/GCB, BAGS as well as drug resistance classification on their own datasets.

The classifications performed by \hemaClass{} were compared to those obtained using cohort based normalisation in four clinical cohorts.
Even though gene expression data for the four cohorts was obtained through varying preparation kits and sample storage methods, the results show that a one-by-one array analysis approach is feasible and performed comparably with the whole cohort based method.
It seems that this approach allows for a realistic application of microarray based lymphoma classification for research projects and, after suitable standardisation and calibration, even for clinical use.

The present treatment algorithms for DLBCL are based on disease stage and clinical risk stratification without accounting for underlying tumour-biology \citep{Schmoll2012} and does not routinely account for the enormous variations in tumor biology between patients.
The CHOP combination therapy (cyclophosphamide, doxorubicin, vincristine, and prednisone) has been the backbone of DLBCL therapy for decades with the only significant improvement being the addition of monoclonal CD20 antibodies (rituximab) \citep{Coiffier2002a}.
Despite the addition of antibody therapy to conventional chemotherapy only $55\%$ of patients with poor risk disease achieve durable remission \citep{Ziepert2010}.
Thus, the need for new therapeutic options in DLBCL is obvious.
Currently a number of new drugs have shown promising activity in DLBCL, but their role outside clinical trials have not been defined.
These drugs are different from conventional chemotherapeutic compounds by targeting specific deregulated cell-cycle pathways \citep{Friedberg2011}.
An important example is inhibition of the NF-$\kappa$B pathway by proteasome inhibitors (i.e.\ bortezomib).
Interestingly, the constitutive activation of the NF-$\kappa$B pathway is characteristic for the ABC subtype of DLBCL and consistently bortezomib induces more activity in this subtype \citep{Nogai2013}.\todo{Check if sentence is factually correct. Bortezomib induces more activity or decreases it?}{}
With the increasing number of new drugs likely to become available over the next years and the fact that their efficacy may vary between subsets of patients defined by gene expression profiles, the current treatment of patients based on disease stage and clinical information alone will not be sufficient.
\hemaClass{} provides an example of fast processing of complex molecular information in a way that is simple and readily at hand for clinicians.

An immediate limitation of the study is the need for a reference dataset established under the same conditions as the samples one wishes to classify.
However, calibration of laboratory equipment is a well-known issue for many experimental techniques used in molecular biology like qPCR, mass spectrometry, immunohistochemistry, and flow cytometry.
An important part of the calibration is that samples should be calibrated towards a dataset consisting of a representative set of tissue samples.
For the microarray technology this could be solved by inventing a central tissue bank of e.g.\ B-cell cancer cell-lines of varying subtypes which could be used as reference set for each individual microarray platform.

The user reference dataset is important if one wish to use the conventionally used thresholds for classification.
However, without a user reference set, the high correlation coefficients demonstrate that equally high classification accuracies can be achieved if laboratory specific thresholds are carefully chosen.

Another limitation of the current web application is that it is only designed for one array type.
The server works at the moment only on Affymetrix HG-U133 Plus 2.0 microarrays, but extensions to other high throughput platforms and cancers are planned.
This can, however, be circumvented by either re-annotation to HUGO Gene Nomenclature Committee (HGNC) approved symbols as suggested by \citet{Care2013} or by re-annotated chip definition files as suggested by \citep{Dai2005}.
At the moment we are working on extending the web application to other array types along these lines of \citep{Dai2005}.

Traditionally ABC/GCB classification has been achieved using the naive Bayes classifier of \citet{Wright2003} which is based on cohorts, MAS5.0 normalised arrays, and a Bayesian approach assuming an equal amount of ABC and GCB patients.
However, a classifier based on logistic regression regularised by an elastic net penalty was implemented to make the classification more adaptable to RMA normalisation, one-by-one processing, and stable towards varying amounts of ABC/GCB patients.
This classifier proved to be quite comparable with the naive Bayes classifier over the four studied datasets confirming the strong and stable signal of the ABC/GBC subclasses of DLBCL.

Under the validation of the one-by-one method one should notice that the unclassified is treated as a class in its own right.
This implies a lower accuracy compared to an approach where the unclassified are left out of the validations.
The latter approach seems reasonable as changing classifications to unclassified is less serious than changing real classes.
Despite the disputed properties of Cohen's $\kappa$ the conservative approach is retained and the issue is addressed using a Cohen's weighted $\kappa$ approach.
Given that an idealised approach is problematic to formulate, readers are encouraged to consider the confusion matrices in the supplementary material to make an overall evaluation of the performance.

ABC/GCB, BAGS, and REGS are only a part of the GEP-based armamentarium of methods for stratifying lymphoma patients into risk groups \citep{Shipp2002, Lossos2004a, Malumbres2008} and it would be interesting to extend the tool to include other classification systems.
For a comprehensive review see \citep{Coutinho2013}.
To our knowledge only a few other classification methods from other cancer types have been made easily accessible as either web applications or desktop applications.
Hopefully, this research will inspire bioinformaticians and statisticians to make their cancer classification methods easily accessible for usage, speedy validation, critical reviews, and mutual inspiration.

\section{Conclusion}
Despite high throughput molecular biology has been around for more than a decade, only a few of the numerous biomarkers identified have undergone extensive validation and made it into the clinic \citep{Chen2012a}.
It is our hope that making our own findings publicly available in this way will speed up validation and testing of BAGS and REGS by other researchers without having to delve into extensive bioinformatics implementations.
Although \hemaClass{} is still separated from the clinic we believe a web based tool and suggestion for a clinical reference sample will bring cancer classification closer to the clinic.
Hopefully, this work can also spawn interesting discussions on the clinical requirements of GEP based diagnostic and prognostic tools.

All material for reproducing this paper and its results is found at \url{https://github.com/oncoclass/hemaclass-paper}.
Comments, suggest, bug reports, and other issues are warmly welcome at \url{https://github.com/oncoclass/hemaclass/issue} or by mail to the corresponding author.

\phantomsection
\addcontentsline{toc}{section}{Acknowledgements}
\section*{Acknowledgements}
We thank Mads Boye and Bo Nygaard Bai at IT Services, Aalborg University, for their assistance on deploying the public server.
SF is supported by a Mobility PhD fellowship at the Graduate School of Health, Faculty of Health Sciences, Aarhus University.
The research is supported by MSCNET, a translational programme studying cancer stem cells in multiple myeloma supported by the EU FP6, and CHEPRE, a programme studying chemo sensitivity in malignant lymphoma by genomic signatures supported by the Danish Agency for Science, Technology, and Innovation as well as Karen Elise Jensen Fonden.
The technical assistance from Ann-Maria Jensen, Louise Hvilsh{\o}j Madsen, and Helle H{\o}holt is greatly appreciated.



\noindent\textit{Conflict of interest statement}: None declared.
\phantomsection
\addcontentsline{toc}{section}{References}
\bibliographystyle{plainnat} %abbrvnat
\bibliography{references}


% Supplementary material
\cleardoublepage

% Prefix S to figures, tables, etc
\renewcommand{\theequation}{S\arabic{equation}}
\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\arabic{table}}
\renewcommand{\thesection}{S\arabic{section}}

% reset counters
\setcounter{section}{0}
\setcounter{subsection}{0}
\setcounter{equation}{0}
\setcounter{figure}{0}
\setcounter{table}{0}
\setcounter{page}{1}

\input{supplementary.tex}

\cleardoublepage
\listoftodos









\end{document}







